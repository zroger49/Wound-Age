---
title: "explore_degs"
author: "Rog√©rio Ribeiro"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
shhh <- suppressPackageStartupMessages
shhh(library(tidyverse))
shhh(library(ggrepel))
shhh(library(UpSetR))
```

Divided the samples into 3 groups -> Min/hours
                                  -> 1-3 days
                                  -> 4-28 days

# Make a plot of the metadata


```{r}
metadata <- read.csv("../data/metadata_analysis_tac.txt", sep = "\t")

metadata_per_group <- metadata %>% 
  group_by(Timepoint1) %>% 
  summarise(n = n())

a <- ggplot(metadata_per_group, aes(x = Timepoint1, y = n, fill = Timepoint1)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(x = " ", y = "Sample size", title = "Sample size (Condition)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")  + # Use a color palette
  theme(axis.text.x = element_text(size = 14))




pdf("../results_new/02_degs/01_metadata_barplot.pdf", w = 8)
print(a)
dev.off()

print(a)
```
# Plot the number of DEGs in each comparison


y ~ timepoint + age + sex + RIN +  PMI + 1 | individual + 1 | batch +  1 | Sample_site

Timepoint can be control, early, intermediary and late
Early are samples taken min-hours. Intermediary are samples taken 1-3 days. Late are other samples


Note: On the Tables the down genes are upregulated on the Wound vs control. 
On the plot its the opposite since its easier to interpret

```{r}
fdr_treshold <- 0.05
# logFC difference # Null

degs_early <- read.csv("../results_new/02_degs/control_early.txt", sep = "\t", dec = ",", skip = 4) %>% 
   filter(FDR.P.val < fdr_treshold)

degs_intermediary <- read.csv("../results_new/02_degs/control_intermediary.txt", sep = "\t", dec = ",", skip = 4) %>% 
   filter(FDR.P.val < fdr_treshold)

degs_late <- read.csv("../results_new/02_degs/control_late.txt", sep = "\t", dec = ",", skip = 4) %>% 
   filter(FDR.P.val < fdr_treshold)

# Between timepoint comparison
degs_early_intermediary <- read.csv("../results_new/02_degs/early_intermediary.txt", sep = "\t", dec = ",", skip = 4) %>% 
   filter(FDR.P.val < fdr_treshold)

degs_intermediary_late <- read.csv("../results_new/02_degs/intermediary_late.txt", sep = "\t", dec = ",", skip = 4) %>% 
   filter(FDR.P.val < fdr_treshold)

list_of_degs <- list(
  control_early = degs_early,
  control_intermediary = degs_intermediary,
  control_late = degs_late,
  early_intemediary = degs_early_intermediary,
  intemediary_late = degs_intermediary_late
)

list_of_degs <- lapply(list_of_degs, function(x) x %>% mutate(Fold.Change = -Fold.Change))

number_of_degs <- lapply(names(list_of_degs), function(x) {
  degs <- list_of_degs[[x]]
  down <- nrow(degs %>% filter(Fold.Change < 0 ))
  up <- nrow(degs %>% filter(Fold.Change > 0 ))
  
  data.frame("Comparison" = x, "Downregulated" = up, "Upregulated" = down)
  } 
)

number_of_degs <- do.call("rbind", number_of_degs)

degs_summary_long <- number_of_degs %>%
  pivot_longer(cols = c(Upregulated, Downregulated), names_to = "Regulation", values_to = "Count")

# Plot the bar chart
a <- ggplot(degs_summary_long, aes(x = Comparison, y = Count, fill = Regulation)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(x = "", y = "Number of DEGs", title = "", fill = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        legend.text = element_text(size = 16, color = "black"),
        ) +
  scale_fill_manual(values = c("Upregulated" = "#CC6677", "Downregulated" = "#88CCEE"))  

pdf("../results_new/02_degs/02_degs.pdf", w = 8, h = 5)
print(a)
dev.off()

print(a)
```

Control vs intermediary is where I see more differential expressed genes. Intermediary vs late downregulated genes matches with the control vs intermediary analysis.
However, due to the number of samples I wonder if this analysis is correctly made.



# Overlap between comparison

Not taken into account directions here, because early vs intermediary upregulated might be down in early and it would be meaningful. Although, we have to take care in control_vs intermediary, as that comparison has a lot of downregulated genes. 

```{r}

# Create a list of the gene sets
gene_sets <- list(
  "Control vs Early" = degs_early$ID,
  "Control vs Intermediary" = degs_intermediary$ID,
  "Control vs Late" = degs_late$ID,
  "Early vs Intermediary" = degs_early_intermediary$ID,
  "Intermediary vs Late" = degs_intermediary_late$ID
)

# Generate the upset plot
a <- upset(fromList(gene_sets), 
      sets = c("Control vs Early", "Control vs Intermediary",  "Control vs Late" , "Early vs Intermediary", "Intermediary vs Late"),
      order.by = "freq",  # Optional: Order intersections by frequency
      main.bar.color = "#56B4E9",  # Customize main bars color
      sets.bar.color = "#009E73")  # Customize set bars color

pdf("../results_new/02_degs/02_upSetR.pdf", w = 8, h = 4)
print(a)
dev.off()

print(a)

```
Bigest overlap are between control and intermediary and intemediary and late. Meaning we are mostly capturing the same signal. 
Lot ofisnal with the early vs intermediary comparison and these two. 

There is also an overlap between control and intermediary and control vs early (200 genes). The % of genes is small, but might mean we are finding an overlaping signal. I don't think its the same because there are a lot of genes between early and intermediary. 


# Make volcano plots across comparisons

```{r}

fdr_treshold <- 0.05

files_to_plot <- list(
  "Control - Early" = "../results_new/02_degs/control_early.txt",
  "Control - Intermediary" = "../results_new/02_degs/control_intermediary.txt",
  "Control - Late" = "../results_new/02_degs/control_late.txt",
  "Early vs Intermediary" = "../results_new/02_degs/early_intermediary.txt",
  "Intermediary vs Late" = "../results_new/02_degs/intermediary_late.txt"
)

# Load and filter all files
degs_data <- lapply(files_to_plot, function(file) {
  a <- read.csv(file,  sep = "\t", dec = ",", skip = 4) %>% mutate(deg_status = ifelse(FDR.P.val < fdr_treshold, "DEG", "Not DEG"))
  colnames(a)[4] <- "FC"
  a$FC <- -a$FC
  return (a)
})

plot_volcano <- function(data, title, n_genes_to_be_labeled = 10) {
  top_degs <- data %>%
    filter(FDR.P.val < 0.05) %>%
    arrange(desc(abs(FC))) %>%
    slice_head(n = 10) %>%
    pull(ID)  # Extract gene IDs
  
  data <- data %>%
    mutate(Description = ifelse(ID %in% top_degs, ID, NA)) %>% 
    mutate(logFC = ifelse(FC > 0, log2(FC), -log2(-FC)))
  
  # Step 3: Create the plot
  ggplot(data, aes(x = logFC, y = -log10(P.val), colour = deg_status, label = Description)) +
    geom_point(alpha = 0.6) +
    geom_text_repel(aes(fontface=2))  +
    scale_alpha_manual(values = c(0.7, 1)) + 
    theme_minimal() + 
    scale_color_manual(values = c("DEG" = "black", "Not DEG" = "grey78")) +
    theme_minimal() +
    labs(title = title, x = "Log Fold Change", y = "-log10(P.val)") +
    theme(legend.position = "none")
}


for (name in names(degs_data)) {
  plot_name <- file.path("../results_new/02_degs/", paste0("03_volcano_", gsub(" |-", "_", name), ".pdf"))
  a <- plot_volcano(degs_data[[name]], name)
  print(a) # Show in the Rmd file
  pdf(plot_name) # Saves in disk
  print(a)
  dev.off() 
}
```
Not much to say about the volcano plots. Might be used to highlight some of the top genes.

# P.values plot 

```{r}
for (comp in names(degs_data)){
  degs <- degs_data[[comp]]
  
  a <- ggplot(degs, aes(x = P.val)) + 
    geom_histogram(fill = "lightblue", colour = "grey30", binwidth = 0.01, show.legend = FALSE) +
    geom_vline(xintercept = c(0.05), color = "red", linetype = "dashed", alpha = 0.5, linewidth = 0.5) +
    xlab(bquote("pvalue")) +
    ylab("Counts") +
    theme_bw() +
    theme(strip.text = element_text(size = 12)) + 
    ggtitle(comp) 
  
  pdf(paste0("../results_new/02_degs/04_pvalue_distribution", comp, ".pdf"))
  print(a)
  dev.off()

  print(a)
}

```
p.values distribution looks fine

# Plot the expression of selected genes across timepoint (TODO)